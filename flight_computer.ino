#include <Wire.h>
#include <Adafruit_BMP280.h>
#include <Adafruit_MPU6050.h>
#include <queue>
#include <LittleFS.h>

Adafruit_BMP280 bmp;
Adafruit_MPU6050 mpu;

#define BMP_ADDR  0x76       // or 0x77
#define MPU_ADDR  0x68       // or 0x69
#define BUZZER_PIN 0   // D3 pin = GPIO0
#define DEBUG 0
#define REMOVE 1
#define SENSOR_READ 0
#define BATTERY_VOLTAGE_PIN A0
#define PYRO_PIN 15

#if !SENSOR_READ
struct Sample {
  float t;    // Time (s)
  float alt;  // Altitude (m)
  float az;   // Vertical acceleration (m/s^2)
  float ax;   // Lateral acceleration (m/s^2)
};

const Sample flightData[] PROGMEM = {
  //  t      alt      az        ax
  {0,0,0,0},
  {0.002,0,0,0},
  {0.004,0,0,0},
  {0.006,0,0,0},
  {0.008,0,0,0},
  {0.01,0,0,0},
  {0.011,0,0,0},
  {0.012,0,0,0},
  {0.014,0,0,0},
  {0.017,0,0.975,0},
  {0.018,0,2.477,0},
  {0.02,0,4.814,0},
  {0.022,0,7.152,0},
  {0.024,0,9.489,0},
  {0.026,0,11.743,0},
  {0.028,0,13.996,0},
  {0.03,0.001,16.25,0},
  {0.031,0.001,17.377,0},
  {0.033,0.001,19.35,0},
  {0.035,0.001,21.981,0},
  {0.037,0.002,25.27,0},
  {0.039,0.002,27.219,0},
  {0.041,0.003,29.169,0},
  {0.043,0.004,31.119,0},
  {0.045,0.005,33.07,0},
  {0.046,0.005,34.045,0},
  {0.048,0.006,35.738,0},
  {0.05,0.007,37.995,0},
  {0.052,0.009,40.253,0},
  {0.053,0.01,41.946,0},
  {0.055,0.012,43.923,0},
  {0.057,0.013,45.899,0},
  {0.059,0.015,47.876,0},
  {0.061,0.018,49.854,0},
  {0.063,0.02,51.417,0},
  {0.065,0.023,52.981,0},
  {0.067,0.026,54.545,0},
  {0.069,0.029,56.11,0},
  {0.07,0.03,56.892,0},
  {0.072,0.033,58.066,0},
  {0.074,0.036,59.631,0},
  {0.076,0.04,61.196,0},
  {0.078,0.044,62.762,0},
  {0.079,0.047,63.936,0},
  {0.081,0.052,65.698,0},
  {0.083,0.057,67.459,0},
  {0.085,0.062,69.221,0},
  {0.087,0.067,70.983,0},
  {0.088,0.07,71.864,0},
  {0.09,0.074,73.516,0},
  {0.092,0.08,75.719,0},
  {0.094,0.086,77.922,0},
  {0.096,0.095,80.677,0},
  {0.098,0.102,82.247,0},
  {0.1,0.109,83.818,0},
  {0.102,0.116,85.389,0},
  {0.104,0.124,86.96,0},
  {0.105,0.129,87.745,0},
  {0.107,0.135,88.711,0},
  {0.109,0.144,89.999,0},
  {0.111,0.153,91.287,0},
  {0.113,0.162,92.576,0},
  {0.115,0.172,93.864,0},
  {0.116,0.18,94.831,0},
  {0.118,0.19,96.44,0},
  {0.12,0.201,98.05,0},
  {0.122,0.213,99.661,0},
  {0.124,0.224,101.271,0},
  {0.126,0.236,102.882,0},
  {0.127,0.243,103.687,0},
  {0.129,0.252,104.508,0},
  {0.131,0.265,105.603,0},
  {0.133,0.279,106.698,0},
  {0.135,0.292,107.793,0},
  {0.137,0.307,108.888,0},
  {0.139,0.322,109.983,0},
  {0.14,0.333,110.805,0},
  {0.142,0.348,112.037,0},
  {0.144,0.364,113.269,0},
  {0.146,0.381,114.502,0},
  {0.148,0.398,115.734,0},
  {0.15,0.415,116.967,0},
  {0.152,0.433,118.199,0},
  {0.153,0.442,118.816,0},
  {0.155,0.456,119.537,0},
  {0.157,0.475,120.499,0},
  {0.159,0.494,121.462,0},
  {0.161,0.514,122.424,0},
  {0.163,0.534,123.386,0},
  {0.165,0.555,124.348,0},
  {0.166,0.571,125.07,0},
  {0.168,0.593,125.573,0},
  {0.17,0.615,126.076,0},
  {0.172,0.638,126.579,0},
  {0.174,0.661,127.081,0},
  {0.176,0.685,127.584,0},
  {0.178,0.709,128.086,0},
  {0.18,0.734,128.587,0},
  {0.182,0.759,129.089,0},
  {0.184,0.785,129.59,0},
  {0.186,0.811,130.016,0},
  {0.188,0.838,130.443,0},
  {0.19,0.865,130.869,0},
  {0.192,0.893,131.295,0},
  {0.194,0.922,131.721,0},
  {0.196,0.951,132.146,0},
  {0.198,0.98,132.572,0},
  {0.2,1.01,132.997,0.002},
  {0.201,1.025,133.209,0.002},
  {0.203,1.048,133.216,0.002},
  {0.205,1.083,133.225,0.002},
  {0.208,1.137,133.238,0.002},
  {0.213,1.221,133.255,0.002},
  {0.217,1.286,133.267,0.002},
  {0.223,1.388,132.073,0.002},
  {0.231,1.548,130.277,0.003},
  {0.238,1.681,128.868,0.003},
  {0.248,1.888,126.332,0.003},
  {0.252,1.975,125.315,0.003},
  {0.258,2.109,122.399,0.003},
  {0.263,2.224,119.967,0.003},
  {0.271,2.402,116.612,0.003},
  {0.273,2.462,115.493,0.003},
  {0.277,2.555,113.963,0.003},
  {0.282,2.697,111.668,0.003},
  {0.284,2.738,111.004,0.003},
  {0.286,2.801,110.007,0.003},
  {0.29,2.897,108.511,0.003},
  {0.295,3.027,106.502,0.003},
  {0.302,3.228,103.484,0.003},
  {0.306,3.33,101.99,0.003},
  {0.311,3.484,100.189,0.003},
  {0.317,3.644,98.361,0.003},
  {0.325,3.889,94.263,0.003},
  {0.328,3.97,92.935,0.003},
  {0.332,4.093,91.927,0.003},
  {0.338,4.28,90.413,0.003},
  {0.339,4.311,90.153,0.003},
  {0.341,4.358,89.628,0.004},
  {0.343,4.429,88.839,0.004},
  {0.346,4.536,87.655,0.004},
  {0.351,4.698,85.879,0.004},
  {0.352,4.73,85.547,0.004},
  {0.354,4.779,85.124,0.004},
  {0.356,4.852,84.489,0.004},
  {0.359,4.963,83.536,0.004},
  {0.364,5.131,82.106,0.004},
  {0.365,5.164,81.821,0.004},
  {0.367,5.215,81.39,0.004},
  {0.369,5.29,80.744,0.004},
  {0.373,5.405,79.775,0.004},
  {0.378,5.578,78.32,0.004},
  {0.381,5.694,77.359,0.004},
  {0.386,5.869,76.794,0.004},
  {0.394,6.135,75.945,0.004},
  {0.398,6.295,75.441,0.004},
  {0.405,6.537,74.59,0.004},
  {0.413,6.843,73.531,0.004},
  {0.423,7.218,73.094,0.004},
  {0.433,7.6,72.655,0.004},
  {0.438,7.794,72.434,0.004},
  {0.446,8.088,72.373,0.004},
  {0.453,8.387,72.31,0.004},
  {0.463,8.79,71.693,0.005},
  {0.47,9.078,71.261,0.005},
  {0.48,9.494,71.172,0.005},
  {0.49,9.917,71.08,0.005},
  {0.5,10.347,71.551,0.006},
  {0.51,10.785,72.02,0.006},
  {0.52,11.229,72.485,0.006},
  {0.53,11.681,72.948,0.007},
  {0.538,12.048,73.316,0.007},
  {0.548,12.513,73.556,0.007},
  {0.558,12.985,73.794,0.008},
  {0.564,13.272,73.935,0.008},
  {0.573,13.708,73.637,0.008},
  {0.583,14.199,73.304,0.009},
  {0.593,14.697,72.969,0.009},
  {0.603,15.202,72.631,0.009},
  {0.606,15.355,72.529,0.009},
  {0.611,15.586,72.368,0.01},
  {0.617,15.935,72.126,0.01},
  {0.627,16.458,71.766,0.01},
  {0.637,16.989,71.403,0.011},
  {0.645,17.404,71.121,0.011},
  {0.655,17.947,70.781,0.011},
  {0.665,18.497,70.438,0.012},
  {0.675,19.054,70.094,0.012},
  {0.685,19.618,69.748,0.012},
  {0.689,19.846,69.609,0.012},
  {0.695,20.189,69.318,0.013},
  {0.704,20.709,68.879,0.013},
  {0.714,21.293,68.391,0.013},
  {0.724,21.884,67.9,0.013},
  {0.734,22.482,67.409,0.013},
  {0.742,22.965,67.014,0.013},
  {0.752,23.575,66.439,0.013},
  {0.762,24.191,65.862,0.013},
  {0.772,24.814,65.284,0.013},
  {0.782,25.444,64.705,0.013},
  {0.785,25.634,64.531,0.013},
  {0.79,25.92,64.364,0.013},
  {0.796,26.352,64.112,0.012},
  {0.806,26.997,63.738,0.012},
  {0.816,27.649,63.362,0.012},
  {0.826,28.307,62.985,0.013},
  {0.827,28.373,62.956,0.013},
  {0.829,28.472,62.952,0.013},
  {0.831,28.621,62.946,0.012},
  {0.834,28.846,62.936,0.012},
  {0.839,29.184,62.922,0.012},
  {0.847,29.694,62.898,0.012},
  {0.857,30.371,62.866,0.012},
  {0.867,31.055,62.831,0.012},
  {0.877,31.745,62.794,0.013},
  {0.887,32.441,62.754,0.013},
  {0.897,33.141,62.713,0.014},
  {0.907,33.85,62.538,0.015},
  {0.917,34.565,62.361,0.016},
  {0.927,35.286,62.183,0.016},
  {0.937,36.013,62.003,0.017},
  {0.947,36.747,61.821,0.018},
  {0.957,37.487,61.638,0.018},
  {0.96,37.71,61.583,0.018},
  {0.964,38.046,61.5,0.018},
  {0.971,38.551,61.374,0.018},
  {0.981,39.306,61.187,0.018},
  {0.991,40.067,60.998,0.018},
  {1,40.738,60.832,0.018},
  {1.01,41.51,60.64,0.017},
  {1.02,42.288,60.447,0.017},
  {1.03,43.072,60.253,0.017},
  {1.04,43.863,60.056,0.018},
  {1.05,44.659,59.859,0.019},
  {1.06,45.461,59.66,0.02},
  {1.065,45.865,59.56,0.02},
  {1.072,46.473,59.309,0.02},
  {1.082,47.289,58.974,0.019},
  {1.092,48.11,58.638,0.019},
  {1.102,48.938,58.301,0.018},
  {1.112,49.771,57.963,0.018},
  {1.122,50.61,57.625,0.018},
  {1.132,51.455,57.285,0.018},
  {1.135,51.667,57.2,0.018},
  {1.139,51.986,57.016,0.018},
  {1.144,52.466,56.739,0.018},
  {1.153,53.189,56.324,0.019},
  {1.163,54.051,55.832,0.019},
  {1.173,54.918,55.339,0.019},
  {1.183,55.792,54.846,0.019},
  {1.193,56.67,54.353,0.019},
  {1.201,57.394,53.949,0.019},
  {1.211,58.282,53.839,0.019},
  {1.221,59.176,53.727,0.018},
  {1.231,60.076,53.614,0.018},
  {1.241,60.98,53.5,0.018},
  {1.251,61.89,53.384,0.018},
  {1.261,62.806,53.267,0.018},
  {1.271,63.726,53.149,0.019},
  {1.281,64.652,53.029,0.02},
  {1.291,65.584,52.908,0.02},
  {1.295,65.958,52.859,0.02},
  {1.301,66.52,52.726,0.02},
  {1.31,67.368,52.525,0.019},
  {1.32,68.314,52.302,0.019},
  {1.321,68.409,52.279,0.019},
  {1.323,68.552,52.246,0.019},
  {1.325,68.766,52.195,0.019},
  {1.328,69.087,52.12,0.019},
  {1.333,69.571,52.006,0.019},
  {1.341,70.298,51.835,0.02},
  {1.348,70.992,51.671,0.021},
  {1.358,71.959,51.808,0.023},
  {1.368,72.93,51.942,0.025},
  {1.374,73.516,52.022,0.027},
  {1.383,74.397,51.485,0.028},
  {1.393,75.382,50.89,0.028},
  {1.4,76.074,50.473,0.028},
  {1.41,77.067,50.243,0.029},
  {1.42,78.065,50.012,0.029},
  {1.43,79.068,49.781,0.028},
  {1.437,79.773,49.618,0.027},
  {1.447,80.785,49.16,0.026},
  {1.457,81.801,48.703,0.024},
  {1.467,82.823,48.245,0.021},
  {1.477,83.849,47.786,0.019},
  {1.479,84.055,47.694,0.018},
  {1.482,84.364,47.706,0.018},
  {1.487,84.828,47.723,0.017},
  {1.493,85.527,47.749,0.016},
  {1.503,86.565,47.785,0.016},
  {1.513,87.609,47.819,0.016},
  {1.514,87.713,47.816,0.016},
  {1.516,87.871,47.78,0.016},
  {1.518,88.106,47.726,0.017},
  {1.521,88.46,47.646,0.017},
  {1.526,88.992,47.525,0.019},
  {1.534,89.793,47.343,0.02},
  {1.544,90.851,47.104,0.023},
  {1.554,91.914,46.864,0.025},
  {1.564,92.981,46.624,0.027},
  {1.574,94.053,46.384,0.028},
  {1.584,95.13,46.143,0.029},
  {1.594,96.212,45.902,0.026},
  {1.601,96.968,45.734,0.024},
  {1.611,98.057,45.339,0.022},
  {1.621,99.151,44.944,0.02},
  {1.631,100.249,44.55,0.018},
  {1.641,101.352,44.157,0.018},
  {1.651,102.459,43.764,0.018},
  {1.661,103.57,43.372,0.018},
  {1.663,103.793,43.293,0.018},
  {1.666,104.128,42.982,0.018},
  {1.67,104.63,42.515,0.018},
  {1.677,105.386,41.817,0.018},
  {1.687,106.48,40.811,0.018},
  {1.697,107.607,39.898,0.019},
  {1.707,108.738,38.989,0.021},
  {1.715,109.645,38.264,0.023},
  {1.725,110.783,38.048,0.024},
  {1.735,111.924,37.832,0.025},
  {1.745,113.069,37.617,0.026},
  {1.755,114.218,37.401,0.028},
  {1.765,115.371,37.186,0.029},
  {1.775,116.527,36.971,0.028},
  {1.779,116.991,36.885,0.028},
  {1.785,117.687,36.6,0.027},
  {1.794,118.735,36.172,0.026},
  {1.804,119.902,35.699,0.026},
  {1.814,121.072,35.228,0.025},
  {1.816,121.307,35.134,0.025},
  {1.819,121.659,35.15,0.025},
  {1.824,122.188,35.174,0.024},
  {1.83,122.982,35.21,0.022},
  {1.84,124.162,35.262,0.022},
  {1.85,125.345,35.312,0.023},
  {1.853,125.671,35.326,0.023},
  {1.857,126.161,35.42,0.023},
  {1.863,126.896,35.561,0.024},
  {1.873,128.002,35.769,0.024},
  {1.883,129.197,35.99,0.025},
  {1.893,130.395,36.209,0.025},
  {1.903,131.597,36.426,0.026},
  {1.913,132.803,36.641,0.029},
  {1.919,133.578,36.777,0.032},
  {1.929,134.742,36.556,0.035},
  {1.939,135.957,36.326,0.038},
  {1.947,136.98,36.133,0.041},
  {1.957,138.201,34.781,0.041},
  {1.967,139.427,33.436,0.041},
  {1.973,140.164,32.632,0.04},
  {1.982,141.271,31.839,0.038},
  {1.992,142.505,30.962,0.033},
  {2.002,143.741,30.089,0.029},
  {2.012,144.981,27.676,0.021},
  {2.022,146.223,25.277,0.011},
  {2.024,146.472,24.799,0.01},
  {2.027,146.845,23.95,0.008},
  {2.032,147.406,22.678,0.008},
  {2.038,148.247,20.778,0.012},
  {2.046,149.215,18.606,0.02},
  {2.056,150.465,14.368,0.028},
  {2.065,151.591,10.578,0.033},
  {2.075,152.843,5.008,0.038},
  {2.081,153.594,1.684,0.039},
  {2.09,154.722,-3.021,0.036},
  {2.096,155.473,-6.141,0.033},
  {2.105,156.6,-12.877,0.029},
  {2.109,157.101,-15.858,0.027},
  {2.115,157.851,-18.953,0.025},
  {2.122,158.725,-22.548,0.024},
  {2.132,159.973,-27.655,0.025},
  {2.135,160.346,-29.18,0.025},
  {2.14,160.906,-31.462,0.025},
  {2.146,161.745,-34.87,0.023},
  {2.148,161.962,-35.751,0.023},
  {2.151,162.288,-36.542,0.022},
  {2.155,162.776,-37.724,0.02},
  {2.16,163.506,-39.492,0.016},
  {2.169,164.6,-42.131,0.01},
  {2.175,165.298,-43.812,0.006},
  {2.184,166.343,-45.465,0.002},
  {2.194,167.567,-47.397,0.011},
  {2.201,168.481,-48.836,0.017},
  {2.211,169.697,-48.484,0.02},
  {2.221,170.908,-48.136,0.018},
  {2.231,172.114,-47.792,0.012},
  {2.241,173.315,-47.453,0.008},
  {2.251,174.511,-47.118,0.01},
  {2.261,175.703,-46.787,0.015},
  {2.271,176.89,-46.463,0.019},
  {2.281,178.072,-46.144,0.021},
  {2.291,179.25,-45.828,0.02},
  {2.301,180.423,-45.516,0.018},
  {2.311,181.592,-45.207,0.014},
  {2.321,182.756,-44.903,0.009},
  {2.331,183.916,-44.602,0.008},
  {2.341,185.071,-44.304,0.011},
  {2.351,186.222,-44.01,0.014},
  {2.361,187.368,-43.72,0.017},
  {2.371,188.51,-43.433,0.019},
  {2.381,189.648,-43.149,0.019},
  {2.391,190.781,-42.868,0.018},
  {2.401,191.91,-42.591,0.013},
  {2.411,193.035,-42.317,0.005},
  {2.421,194.155,-42.046,0.006},
  {2.431,195.272,-41.778,0.013},
  {2.441,196.384,-41.513,0.02},
  {2.451,197.492,-41.251,0.024},
  {2.461,198.596,-40.992,0.027},
  {2.471,199.696,-40.736,0.026},
  {2.481,200.791,-40.483,0.021},
  {2.491,201.883,-40.233,0.015},
  {2.501,202.971,-39.985,0.008},
  {2.511,204.054,-39.74,0.003},
  {2.521,205.134,-39.498,0.007},
  {2.531,206.21,-39.258,0.013},
  {2.541,207.282,-39.021,0.017},
  {2.551,208.349,-38.787,0.02},
  {2.561,209.413,-38.555,0.02},
  {2.571,210.474,-38.326,0.019},
  {2.581,211.53,-38.099,0.017},
  {2.591,212.582,-37.874,0.014},
  {2.601,213.631,-37.652,0.012},
  {2.611,214.676,-37.432,0.011},
  {2.621,215.717,-37.214,0.01},
  {2.631,216.755,-36.999,0.012},
  {2.641,217.789,-36.786,0.016},
  {2.651,218.819,-36.575,0.018},
  {2.661,219.845,-36.366,0.018},
  {2.671,220.868,-36.16,0.016},
  {2.681,221.887,-35.956,0.012},
  {2.691,222.903,-35.755,0.008},
  {2.701,223.915,-35.557,0.003},
  {2.711,224.923,-35.36,0.005},
  {2.721,225.928,-35.165,0.01},
  {2.731,226.93,-34.972,0.014},
  {2.741,227.928,-34.781,0.018},
  {2.751,228.922,-34.592,0.02},
  {2.761,229.913,-34.405,0.021},
  {2.771,230.901,-34.22,0.02},
  {2.781,231.885,-34.036,0.019},
  {2.791,232.866,-33.855,0.017},
  {2.801,233.843,-33.675,0.015},
  {2.811,234.817,-33.496,0.013},
  {2.821,235.787,-33.32,0.012},
  {2.831,236.755,-33.145,0.011},
  {2.841,237.719,-32.972,0.011},
  {2.851,238.679,-32.8,0.01},
  {2.861,239.637,-32.63,0.01},
  {2.871,240.591,-32.462,0.008},
  {2.881,241.542,-32.295,0.007},
  {2.891,242.49,-32.13,0.006},
  {2.901,243.434,-31.967,0.005},
  {2.911,244.375,-31.804,0.007},
  {2.921,245.313,-31.644,0.011},
  {2.931,246.248,-31.485,0.015},
  {2.941,247.18,-31.327,0.018},
  {2.951,248.109,-31.171,0.021},
  {2.961,249.034,-31.016,0.023},
  {2.971,249.956,-30.863,0.023},
  {2.981,250.876,-30.711,0.022},
  {2.991,251.792,-30.56,0.02},
  {3.001,252.705,-30.411,0.017},
  {3.011,253.615,-30.263,0.014},
  {3.021,254.523,-30.117,0.011},
  {3.031,255.427,-29.971,0.009},
  {3.041,256.328,-29.827,0.01},
  {3.051,257.226,-29.685,0.013},
  {3.061,258.121,-29.543,0.016},
  {3.071,259.013,-29.403,0.018},
  {3.081,259.903,-29.264,0.019},
  {3.091,260.789,-29.127,0.018},
  {3.101,261.672,-28.99,0.014},
  {3.111,262.553,-28.855,0.01},
  {3.121,263.431,-28.721,0.004},
  {3.131,264.305,-28.588,0.002},
  {3.141,265.177,-28.456,0.009},
  {3.151,266.046,-28.325,0.014},
  {3.161,266.913,-28.196,0.019},
  {3.171,267.776,-28.067,0.022},
  {3.181,268.637,-27.94,0.024},
  {3.191,269.494,-27.813,0.023},
  {3.201,270.349,-27.688,0.021},
  {3.211,271.202,-27.564,0.017},
  {3.221,272.051,-27.441,0.012},
  {3.231,272.898,-27.32,0.007},
  {3.241,273.742,-27.2,0.001},
  {3.251,274.583,-27.08,0.005},
  {3.261,275.422,-26.962,0.011},
  {3.271,276.258,-26.845,0.015},
  {3.281,277.091,-26.728,0.018},
  {3.291,277.922,-26.613,0.019},
  {3.301,278.75,-26.499,0.019},
  {3.311,279.575,-26.385,0.017},
  {3.321,280.397,-26.273,0.014},
  {3.331,281.217,-26.161,0.01},
  {3.341,282.035,-26.05,0.006},
  {3.351,282.849,-25.94,0.004},
  {3.361,283.662,-25.831,0.006},
  {3.371,284.471,-25.723,0.01},
  {3.381,285.278,-25.616,0.014},
  {3.391,286.083,-25.509,0.016},
  {3.401,286.885,-25.404,0.018},
  {3.411,287.684,-25.299,0.019},
  {3.421,288.481,-25.195,0.018},
  {3.431,289.275,-25.092,0.016},
  {3.441,290.067,-24.99,0.014},
  {3.451,290.856,-24.888,0.01},
  {3.461,291.643,-24.787,0.006},
  {3.471,292.427,-24.688,0.002},
  {3.481,293.209,-24.588,0.002},
  {3.491,293.989,-24.49,0.005},
  {3.501,294.766,-24.392,0.008},
  {3.511,295.54,-24.296,0.011},
  {3.521,296.312,-24.199,0.013},
  {3.531,297.082,-24.104,0.014},
  {3.541,297.849,-24.009,0.014},
  {3.551,298.614,-23.915,0.013},
  {3.561,299.376,-23.822,0.011},
  {3.571,300.136,-23.73,0.008},
  {3.581,300.894,-23.638,0.005},
  {3.591,301.649,-23.547,0.002},
  {3.601,302.402,-23.456,0.003},
  {3.611,303.153,-23.366,0.006},
  {3.621,303.901,-23.277,0.009},
  {3.631,304.647,-23.189,0.011},
  {3.641,305.391,-23.101,0.012},
  {3.651,306.132,-23.014,0.012},
  {3.661,306.871,-22.927,0.013},
  {3.671,307.608,-22.842,0.012},
  {3.681,308.343,-22.756,0.012},
  {3.691,309.075,-22.672,0.011},
  {3.701,309.805,-22.588,0.01},
  {3.711,310.532,-22.504,0.009},
  {3.721,311.258,-22.422,0.008},
  {3.731,311.981,-22.339,0.008},
  {3.741,312.702,-22.258,0.007},
  {3.751,313.421,-22.177,0.006},
  {3.761,314.137,-22.097,0.006},
  {3.771,314.851,-22.017,0.006},
  {3.781,315.564,-21.938,0.007},
  {3.791,316.273,-21.859,0.007},
  {3.801,316.981,-21.781,0.007},
  {3.811,317.687,-21.703,0.007},
  {3.821,318.39,-21.626,0.007},
  {3.831,319.091,-21.55,0.007},
  {3.841,319.79,-21.474,0.006},
  {3.851,320.487,-21.399,0.005},
  {3.861,321.182,-21.324,0.004},
  {3.871,321.875,-21.249,0.003},
  {3.881,322.565,-21.176,0.002},
  {3.891,323.253,-21.102,0.003},
  {3.901,323.94,-21.03,0.004},
  {3.911,324.624,-20.957,0.005},
  {3.921,325.306,-20.886,0.005},
  {3.931,325.986,-20.815,0.006},
  {3.941,326.664,-20.744,0.006},
  {3.951,327.34,-20.674,0.006},
  {3.961,328.013,-20.605,0.006},
  {3.971,328.685,-20.536,0.006},
  {3.981,329.355,-20.467,0.006},
  {3.991,330.022,-20.399,0.005},
  {4.001,330.688,-20.332,0.005},
  {4.011,331.351,-20.265,0.004},
  {4.021,332.013,-20.198,0.004},
  {4.031,332.672,-20.132,0.004},
  {4.041,333.33,-20.066,0.004},
  {4.051,333.985,-20.001,0.005},
  {4.061,334.639,-19.936,0.005},
  {4.071,335.29,-19.872,0.005},
  {4.081,335.94,-19.808,0.005},
  {4.091,336.587,-19.744,0.005},
  {4.101,337.233,-19.681,0.005},
  {4.111,337.876,-19.619,0.005},
  {4.121,338.518,-19.556,0.004},
  {4.131,339.158,-19.494,0.004},
  {4.141,339.795,-19.433,0.003},
  {4.151,340.431,-19.372,0.003},
  {4.161,341.065,-19.311,0.002},
  {4.171,341.697,-19.251,0.002},
  {4.181,342.327,-19.191,0.002},
  {4.191,342.955,-19.132,0.002},
  {4.201,343.581,-19.073,0.002},
  {4.211,344.205,-19.014,0.003},
  {4.221,344.827,-18.956,0.003},
  {4.231,345.448,-18.898,0.003},
  {4.241,346.066,-18.84,0.003},
  {4.251,346.683,-18.783,0.003},
  {4.261,347.298,-18.726,0.002},
  {4.271,347.911,-18.67,0.002},
  {4.281,348.522,-18.614,0.002},
  {4.291,349.131,-18.558,0.002},
  {4.301,349.738,-18.502,0.002},
  {4.311,350.343,-18.447,0.002},
  {4.321,350.947,-18.393,0.002},
  {4.331,351.549,-18.338,0.002},
  {4.341,352.149,-18.284,0.002},
  {4.351,352.747,-18.231,0.002},
  {4.361,353.343,-18.178,0.002},
  {4.371,353.938,-18.125,0.002},
  {4.381,354.53,-18.072,0.002},
  {4.391,355.121,-18.02,0.002},
  {4.401,355.71,-17.968,0.002},
  {4.411,356.297,-17.916,0.002},
  {4.421,356.883,-17.865,0.002},
  {4.431,357.467,-17.814,0.002},
  {4.441,358.048,-17.763,0.002},
  {4.451,358.629,-17.713,0.003},
  {4.461,359.207,-17.663,0.003},
  {4.471,359.784,-17.613,0.003},
  {4.481,360.358,-17.564,0.003},
  {4.491,360.931,-17.514,0.003},
  {4.501,361.503,-17.466,0.003},
  {4.511,362.072,-17.417,0.003},
  {4.521,362.64,-17.369,0.003},
  {4.531,363.206,-17.321,0.003},
  {4.541,363.77,-17.273,0.003},
  {4.551,364.333,-17.226,0.002},
  {4.561,364.894,-17.179,0.002},
  {4.571,365.453,-17.132,0.002},
  {4.581,366.011,-17.086,0.002},
  {4.591,366.566,-17.04,0.002},
  {4.601,367.12,-16.994,0.001},
  {4.611,367.673,-16.948,0.001},
  {4.621,368.224,-16.903,0.001},
  {4.631,368.772,-16.858,0.001},
  {4.641,369.32,-16.813,0.001},
  {4.651,369.865,-16.768,0.001},
  {4.661,370.409,-16.724,0.001},
  {4.671,370.952,-16.68,0.001},
  {4.681,371.492,-16.636,0.001},
  {4.691,372.031,-16.593,0.002},
  {4.701,372.568,-16.55,0.002},
  {4.711,373.104,-16.507,0.002},
  {4.721,373.638,-16.464,0.002},
  {4.731,374.17,-16.422,0.002},
  {4.741,374.701,-16.38,0.002},
  {4.751,375.23,-16.338,0.002},
  {4.761,375.757,-16.296,0.002},
  {4.771,376.283,-16.255,0.002},
  {4.781,376.807,-16.213,0.003},
  {4.791,377.33,-16.172,0.003},
  {4.801,377.851,-16.132,0.003},
  {4.811,378.37,-16.091,0.003},
  {4.821,378.888,-16.051,0.003},
  {4.831,379.404,-16.011,0.003},
  {4.841,379.918,-15.971,0.003},
  {4.851,380.431,-15.932,0.003},
  {4.861,380.942,-15.893,0.003},
  {4.871,381.452,-15.854,0.003},
  {4.881,381.96,-15.815,0.003},
  {4.891,382.467,-15.776,0.003},
  {4.901,382.972,-15.738,0.002},
  {4.911,383.475,-15.7,0.002},
  {4.921,383.977,-15.663,0.002},
  {4.931,384.477,-15.625,0.002},
  {4.941,384.976,-15.588,0.002},
  {4.951,385.473,-15.551,0.001},
  {4.961,385.968,-15.514,0.001},
  {4.971,386.462,-15.477,0.001},
  {4.981,386.955,-15.441,0.001},
  {4.991,387.446,-15.404,0.001},
  {5.001,387.935,-15.368,0.001},
  {5.011,388.423,-15.332,0.001},
  {5.021,388.909,-15.297,0.001},
  {5.031,389.394,-15.261,0.001},
  {5.041,389.877,-15.226,0.001},
  {5.051,390.359,-15.191,0.001},
  {5.061,390.839,-15.156,0.001},
  {5.071,391.318,-15.122,0.001},
  {5.081,391.795,-15.087,0.001},
  {5.091,392.271,-15.053,0.001},
  {5.101,392.745,-15.019,0.001},
  {5.111,393.218,-14.985,0.001},
  {5.121,393.689,-14.951,0.001},
  {5.131,394.159,-14.918,0.001},
  {5.141,394.627,-14.885,0.001},
  {5.151,395.093,-14.851,0.001},
  {5.161,395.559,-14.819,0.001},
  {5.171,396.022,-14.786,0.001},
  {5.181,396.485,-14.753,0.001},
  {5.191,396.945,-14.721,0.001},
  {5.201,397.405,-14.689,0.001},
  {5.211,397.863,-14.657,0.002},
  {5.221,398.319,-14.625,0.002},
  {5.231,398.774,-14.593,0.002},
  {5.241,399.227,-14.562,0.002},
  {5.251,399.679,-14.531,0.002},
  {5.261,400.13,-14.499,0.002},
  {5.271,400.579,-14.468,0.002},
  {5.281,401.027,-14.438,0.002},
  {5.291,401.473,-14.407,0.002},
  {5.301,401.918,-14.377,0.002},
  {5.311,402.361,-14.346,0.002},
  {5.321,402.803,-14.316,0.002},
  {5.331,403.243,-14.286,0.002},
  {5.341,403.682,-14.257,0.002},
  {5.351,404.12,-14.227,0.002},
  {5.361,404.556,-14.198,0.002},
  {5.371,404.991,-14.168,0.001},
  {5.381,405.424,-14.139,0.002},
  {5.391,405.856,-14.11,0.002},
  {5.401,406.287,-14.082,0.001},
  {5.411,406.716,-14.053,0.001},
  {5.421,407.143,-14.025,0.001},
  {5.431,407.57,-13.996,0.001},
  {5.441,407.995,-13.968,0.001},
  {5.451,408.418,-13.94,0.001},
  {5.461,408.84,-13.912,0.001},
  {5.471,409.261,-13.885,0.001},
  {5.481,409.68,-13.857,0.001},
  {5.491,410.098,-13.83,0.001},
  {5.501,410.515,-13.803,0.001},
  {5.511,410.93,-13.775,0.001},
  {5.521,411.344,-13.748,0.001},
  {5.531,411.756,-13.722,0.001},
  {5.541,412.167,-13.695,0.001},
  {5.551,412.577,-13.669,0.001},
  {5.561,412.985,-13.642,0.001},
  {5.571,413.392,-13.616,0.001},
  {5.581,413.798,-13.59,0.001},
  {5.591,414.202,-13.564,0.001},
  {5.601,414.605,-13.538,0.001},
  {5.611,415.006,-13.513,0.001},
  {5.621,415.407,-13.487,0.001},
  {5.631,415.805,-13.462,0.001},
  {5.641,416.203,-13.437,0.001},
  {5.651,416.599,-13.412,0.001},
  {5.661,416.994,-13.387,0.001},
  {5.671,417.387,-13.362,0.001},
  {5.681,417.779,-13.337,0.001},
  {5.691,418.17,-13.313,0.001},
  {5.701,418.56,-13.288,0.001},
  {5.711,418.948,-13.264,0.001},
  {5.721,419.334,-13.24,0.002},
  {5.731,419.72,-13.216,0.002},
  {5.741,420.104,-13.192,0.002},
  {5.751,420.487,-13.168,0.002},
  {5.761,420.868,-13.145,0.002},
  {5.771,421.249,-13.121,0.002},
  {5.781,421.628,-13.098,0.002},
  {5.791,422.005,-13.075,0.002},
  {5.801,422.381,-13.051,0.002},
  {5.811,422.756,-13.028,0.002},
  {5.821,423.13,-13.006,0.002},
  {5.831,423.502,-12.983,0.002},
  {5.841,423.873,-12.96,0.001},
  {5.851,424.243,-12.938,0.001},
  {5.861,424.612,-12.915,0.001},
  {5.871,424.979,-12.893,0.001},
  {5.881,425.345,-12.871,0.001},
  {5.891,425.709,-12.849,0.001},
  {5.901,426.073,-12.827,0.001},
  {5.911,426.435,-12.805,0.001},
  {5.921,426.796,-12.784,0.001},
  {5.931,427.155,-12.762,0.001},
  {5.941,427.513,-12.741,0.001},
  {5.951,427.87,-12.719,0.001},
  {5.961,428.226,-12.698,0.001},
  {5.971,428.58,-12.677,0.001},
  {5.981,428.933,-12.656,0.001},
  {5.991,429.285,-12.635,0.001},
  {6.001,429.636,-12.615,0.001},
  {6.011,429.985,-12.594,0.001},
  {6.021,430.333,-12.574,0.001},
  {6.031,430.68,-12.553,0.001},
  {6.041,431.026,-12.533,0.001},
  {6.051,431.37,-12.513,0.001},
  {6.061,431.713,-12.493,0.001},
  {6.071,432.055,-12.473,0.001},
  {6.081,432.395,-12.453,0.001},
  {6.091,432.735,-12.433,0.001},
  {6.101,433.073,-12.414,0.001},
  {6.111,433.409,-12.394,0.001},
  {6.121,433.745,-12.375,0.001},
  {6.131,434.079,-12.355,0.001},
  {6.141,434.412,-12.336,0.001},
  {6.151,434.744,-12.317,0.001},
  {6.161,435.075,-12.298,0.001},
  {6.171,435.404,-12.279,0.001},
  {6.181,435.733,-12.261,0.001},
  {6.191,436.06,-12.242,0.001},
  {6.201,436.385,-12.224,0.001},
  {6.211,436.71,-12.205,0.001},
  {6.221,437.033,-12.187,0.001},
  {6.231,437.355,-12.169,0.001},
  {6.241,437.676,-12.15,0.001},
  {6.251,437.996,-12.132,0.001},
  {6.261,438.314,-12.114,0.001},
  {6.271,438.631,-12.097,0.001},
  {6.281,438.947,-12.079,0.001},
  {6.291,439.262,-12.061,0.001},
  {6.301,439.576,-12.044,0.001},
  {6.311,439.888,-12.026,0.001},
  {6.321,440.199,-12.009,0.001},
  {6.331,440.509,-11.991,0.001},
  {6.341,440.818,-11.974,0.001},
  {6.351,441.126,-11.957,0.001},
  {6.361,441.432,-11.94,0.001},
  {6.371,441.737,-11.923,0.001},
  {6.381,442.041,-11.906,0.001},
  {6.391,442.344,-11.89,0.001},
  {6.401,442.646,-11.873,0.001},
  {6.411,442.946,-11.857,0.001},
  {6.421,443.246,-11.84,0.001},
  {6.431,443.544,-11.824,0.001},
  {6.441,443.841,-11.807,0.001},
  {6.451,444.136,-11.791,0.001},
  {6.461,444.431,-11.775,0.001},
  {6.471,444.724,-11.759,0.001},
  {6.481,445.016,-11.743,0.001},
  {6.491,445.307,-11.727,0.001},
  {6.501,445.597,-11.712,0.001},
  {6.511,445.886,-11.696,0.001},
  {6.521,446.173,-11.68,0.001},
  {6.531,446.46,-11.665,0.001},
  {6.541,446.745,-11.65,0.001},
  {6.551,447.029,-11.634,0.001},
  {6.561,447.312,-11.619,0.001},
  {6.571,447.593,-11.604,0.001},
  {6.581,447.874,-11.589,0.001},
  {6.591,448.153,-11.574,0.001},
  {6.601,448.431,-11.559,0.001},
  {6.611,448.708,-11.544,0.001},
  {6.621,448.984,-11.529,0.001},
  {6.631,449.259,-11.515,0.001},
  {6.641,449.533,-11.5,0.001},
  {6.651,449.805,-11.486,0.001},
  {6.661,450.076,-11.471,0.001},
  {6.671,450.346,-11.457,0.001},
  {6.681,450.615,-11.443,0.001},
  {6.691,450.883,-11.429,0.001},
  {6.701,451.15,-11.415,0.001},
  {6.711,451.415,-11.401,0.001},
  {6.721,451.68,-11.387,0.001},
  {6.731,451.943,-11.373,0.001},
  {6.741,452.205,-11.359,0.001},
  {6.751,452.466,-11.345,0.001},
  {6.761,452.726,-11.332,0.001},
  {6.771,452.985,-11.318,0.001},
  {6.781,453.243,-11.305,0.001},
  {6.791,453.499,-11.291,0.001},
  {6.801,453.754,-11.278,0.001},
  {6.811,454.009,-11.265,0.001},
  {6.821,454.262,-11.252,0.001},
  {6.831,454.514,-11.239,0.001},
  {6.841,454.764,-11.226,0.001},
  {6.851,455.014,-11.213,0.001},
  {6.861,455.263,-11.2,0.001},
  {6.871,455.51,-11.187,0.001},
  {6.881,455.757,-11.174,0.001},
  {6.891,456.002,-11.162,0.001},
  {6.901,456.246,-11.149,0.001},
  {6.911,456.489,-11.137,0.001},
  {6.921,456.731,-11.124,0.001},
  {6.931,456.972,-11.112,0.001},
  {6.941,457.211,-11.1,0.001},
  {6.951,457.45,-11.087,0.001},
  {6.961,457.687,-11.075,0.001},
  {6.971,457.924,-11.063,0.001},
  {6.981,458.159,-11.051,0.001},
  {6.991,458.393,-11.039,0},
  {7.001,458.626,-11.028,0},
  {7.011,458.858,-11.016,0},
  {7.021,459.089,-11.004,0},
  {7.031,459.319,-10.992,0},
  {7.041,459.547,-10.981,0},
  {7.051,459.775,-10.969,0},
  {7.061,460.001,-10.958,0},
  {7.071,460.227,-10.947,0},
  {7.081,460.451,-10.935,0},
  {7.091,460.674,-10.924,0},
  {7.101,460.896,-10.913,0},
  {7.111,461.117,-10.902,0},
  {7.121,461.337,-10.891,0},
  {7.131,461.556,-10.88,0},
  {7.141,461.773,-10.869,0},
  {7.151,461.99,-10.858,0},
  {7.161,462.205,-10.847,0},
  {7.171,462.42,-10.837,0},
  {7.181,462.633,-10.826,0},
  {7.191,462.846,-10.815,0},
  {7.201,463.057,-10.805,0},
  {7.211,463.267,-10.795,0},
  {7.221,463.476,-10.784,0},
  {7.231,463.684,-10.774,0},
  {7.241,463.891,-10.764,0},
  {7.251,464.097,-10.753,0},
  {7.261,464.301,-10.743,0},
  {7.271,464.505,-10.733,0},
  {7.281,464.708,-10.723,0},
  {7.291,464.909,-10.713,0},
  {7.301,465.109,-10.704,0},
  {7.311,465.309,-10.694,0},
  {7.321,465.507,-10.684,0},
  {7.331,465.704,-10.674,0},
  {7.341,465.9,-10.665,0},
  {7.351,466.096,-10.655,0},
  {7.361,466.29,-10.646,0},
  {7.371,466.483,-10.636,0},
  {7.381,466.674,-10.627,0},
  {7.391,466.865,-10.618,0},
  {7.401,467.055,-10.608,0},
  {7.411,467.244,-10.599,0},
  {7.421,467.431,-10.59,0},
  {7.431,467.618,-10.581,0},
  {7.441,467.804,-10.572,0},
  {7.451,467.988,-10.563,0},
  {7.461,468.171,-10.554,0},
  {7.471,468.354,-10.545,0},
  {7.481,468.535,-10.537,0},
  {7.491,468.715,-10.528,0},
  {7.501,468.895,-10.519,0},
  {7.511,469.073,-10.511,0},
  {7.521,469.25,-10.502,0},
  {7.531,469.426,-10.494,0},
  {7.541,469.601,-10.485,0},
  {7.551,469.775,-10.477,0},
  {7.561,469.948,-10.469,0},
  {7.571,470.12,-10.46,0},
  {7.581,470.29,-10.452,0},
  {7.591,470.46,-10.444,0},
  {7.601,470.629,-10.436,0},
  {7.611,470.797,-10.428,0},
  {7.621,470.963,-10.42,0},
  {7.631,471.129,-10.412,0},
  {7.641,471.293,-10.404,0},
  {7.651,471.457,-10.397,0},
  {7.661,471.619,-10.389,0},
  {7.671,471.781,-10.381,0},
  {7.681,471.941,-10.374,0},
  {7.691,472.101,-10.366,0},
  {7.701,472.259,-10.359,0},
  {7.711,472.416,-10.351,0},
  {7.721,472.573,-10.344,0},
  {7.731,472.728,-10.336,0},
  {7.741,472.882,-10.329,0},
  {7.751,473.035,-10.322,0},
  {7.761,473.187,-10.315,0},
  {7.771,473.338,-10.308,0},
  {7.781,473.488,-10.301,0},
  {7.791,473.637,-10.294,0},
  {7.801,473.785,-10.287,0},
  {7.811,473.932,-10.28,0},
  {7.821,474.078,-10.273,0},
  {7.831,474.223,-10.266,0},
  {7.841,474.367,-10.259,0},
  {7.851,474.51,-10.253,0},
  {7.861,474.652,-10.246,0},
  {7.871,474.793,-10.239,0},
  {7.881,474.932,-10.233,0},
  {7.891,475.071,-10.226,0},
  {7.901,475.209,-10.22,0},
  {7.911,475.346,-10.214,0},
  {7.921,475.481,-10.207,0},
  {7.931,475.616,-10.201,0},
  {7.941,475.75,-10.195,0},
  {7.951,475.882,-10.189,0},
  {7.961,476.014,-10.183,0},
  {7.971,476.144,-10.176,0},
  {7.981,476.274,-10.17,0},
  {7.991,476.403,-10.164,0},
  {8.001,476.53,-10.159,0.001},
  {8.011,476.657,-10.153,0.001},
  {8.021,476.782,-10.147,0.001},
  {8.031,476.907,-10.141,0.001},
  {8.041,477.03,-10.136,0.001},
  {8.051,477.153,-10.131,0.001},
  {8.061,477.274,-10.125,0.001},
  {8.071,477.395,-10.12,0.001},
  {8.081,477.514,-10.115,0.001},
  {8.091,477.632,-10.11,0.001},
  {8.101,477.75,-10.105,0.001},
  {8.111,477.866,-10.1,0.001},
  {8.121,477.982,-10.095,0.001},
  {8.131,478.096,-10.09,0.001},
  {8.141,478.209,-10.085,0.001},
  {8.151,478.322,-10.08,0.001},
  {8.161,478.433,-10.075,0.001},
  {8.171,478.544,-10.07,0.001},
  {8.181,478.653,-10.065,0.001},
  {8.191,478.761,-10.061,0.001},
  {8.201,478.869,-10.056,0.001},
  {8.202,478.879,-29.231,0.076},
  {8.236,479.227,-25.758,0.065},
  {8.275,479.583,-22.627,0.054},
  {8.319,479.945,-19.837,0.045},
  {8.37,480.306,-17.389,0.037},
  {8.427,480.661,-15.282,0.029},
  {8.493,481,-13.517,0.022},
  {8.567,481.308,-12.093,0.017},
  {8.649,481.571,-11.01,0.011},
  {8.74,481.768,-10.268,0.007},
  {8.837,481.882,-9.868,0.003},
  {8.906,481.905,-9.791,0},
  {9.008,481.854,-9.62,0.004},
  {9.112,481.698,-9.108,0.008},
  {9.222,481.424,-8.255,0.012},
  {9.343,481,-7.061,0.015},
  {9.484,480.363,-5.525,0.017},
  {9.665,479.367,-3.648,0.017},
  {9.939,477.585,-1.428,0.014},
  {10.358,474.531,0.064,0.008},
  {10.743,471.607,0.003,0.004},
  {11.13,468.679,0.003,0.002},
  {11.517,465.752,0.003,0.001},
  {11.903,462.826,0.003,0},
  {12.29,459.901,0.003,0},
  {12.676,456.977,0.003,0},
  {13.062,454.054,0.003,0},
  {13.449,451.131,0.003,0},
  {13.835,448.21,0.003,0},
  {14.221,445.289,0.003,0},
  {14.607,442.369,0.003,0},
  {14.993,439.45,0.003,0},
  {15.379,436.532,0.003,0},
  {15.765,433.614,0.003,0},
  {16.151,430.698,0.003,0},
  {16.537,427.782,0.003,0},
  {16.923,424.867,0.003,0},
  {17.308,421.953,0.003,0},
  {17.694,419.04,0.003,0},
  {18.08,416.127,0.003,0},
  {18.465,413.216,0.003,0},
  {18.851,410.305,0.003,0},
  {19.236,407.395,0.003,0},
  {19.622,404.486,0.003,0},
  {20.007,401.578,0.003,0},
  {20.392,398.671,0.003,0},
  {20.777,395.764,0.003,0},
  {21.163,392.859,0.003,0},
  {21.548,389.954,0.003,0},
  {21.933,387.05,0.003,0},
  {22.318,384.146,0.003,0},
  {22.703,381.244,0.003,0},
  {23.088,378.343,0.003,0},
  {23.472,375.442,0.003,0},
  {23.857,372.542,0.003,0},
  {24.242,369.643,0.003,0},
  {24.627,366.745,0.003,0},
  {25.011,363.847,0.003,0},
  {25.396,360.951,0.003,0},
  {25.78,358.055,0.003,0},
  {26.165,355.16,0.003,0},
  {26.549,352.266,0.003,0},
  {26.933,349.373,0.003,0},
  {27.318,346.48,0.003,0},
  {27.702,343.588,0.003,0},
  {28.086,340.698,0.003,0},
  {28.47,337.808,0.003,0},
  {28.854,334.918,0.003,0},
  {29.238,332.03,0.003,0},
  {29.622,329.142,0.003,0},
  {30.006,326.256,0.003,0},
  {30.39,323.37,0.003,0},
  {30.774,320.485,0.003,0},
  {31.158,317.6,0.003,0},
  {31.541,314.717,0.003,0},
  {31.925,311.834,0.003,0},
  {32.309,308.952,0.003,0},
  {32.692,306.071,0.003,0},
  {33.076,303.191,0.003,0},
  {33.459,300.311,0.003,0},
  {33.842,297.433,0.003,0},
  {34.226,294.555,0.003,0},
  {34.609,291.678,0.003,0},
  {34.992,288.801,0.003,0},
  {35.375,285.926,0.003,0},
  {35.758,283.051,0.003,0},
  {36.141,280.177,0.003,0},
  {36.524,277.304,0.003,0},
  {36.907,274.432,0.003,0},
  {37.29,271.561,0.003,0},
  {37.673,268.69,0.003,0},
  {38.056,265.82,0.003,0},
  {38.439,262.951,0.003,0},
  {38.821,260.083,0.003,0},
  {39.204,257.215,0.003,0},
  {39.586,254.349,0.003,0},
  {39.969,251.483,0.003,0},
  {40.351,248.618,0.003,0},
  {40.734,245.753,0.003,0},
  {41.116,242.89,0.003,0},
  {41.499,240.027,0.003,0},
  {41.881,237.165,0.003,0},
  {42.263,234.304,0.003,0},
  {42.645,231.444,0.003,0},
  {43.027,228.584,0.003,0},
  {43.409,225.725,0.003,0},
  {43.791,222.867,0.003,0},
  {44.173,220.01,0.003,0},
  {44.555,217.154,0.003,0},
  {44.937,214.298,0.003,0},
  {45.319,211.443,0.003,0},
  {45.7,208.589,0.003,0},
  {46.082,205.736,0.003,0},
  {46.464,202.883,0.003,0},
  {46.845,200.032,0.003,0},
  {47.227,197.181,0.003,0},
  {47.608,194.331,0.003,0},
  {47.99,191.481,0.003,0},
  {48.371,188.633,0.003,0},
  {48.752,185.785,0.003,0},
  {49.133,182.938,0.003,0},
  {49.515,180.091,0.003,0},
  {49.896,177.246,0.003,0},
  {50.277,174.401,0.003,0},
  {50.658,171.557,0.003,0},
  {51.039,168.714,0.003,0},
  {51.42,165.872,0.003,0},
  {51.801,163.03,0.003,0},
  {52.182,160.189,0.003,0},
  {52.562,157.349,0.003,0},
  {52.943,154.51,0.003,0},
  {53.324,151.671,0.003,0},
  {53.704,148.833,0.003,0},
  {54.085,145.996,0.003,0},
  {54.466,143.16,0.003,0},
  {54.846,140.324,0.003,0},
  {55.226,137.49,0.003,0},
  {55.607,134.656,0.003,0},
  {55.987,131.822,0.003,0},
  {56.367,128.99,0.003,0},
  {56.748,126.158,0.003,0},
  {57.128,123.327,0.003,0},
  {57.508,120.497,0.003,0},
  {57.888,117.668,0.003,0},
  {58.268,114.839,0.003,0},
  {58.648,112.011,0.003,0},
  {59.028,109.184,0.003,0},
  {59.408,106.357,0.003,0},
  {59.788,103.532,0.003,0},
  {60.167,100.707,0.003,0},
  {60.547,97.883,0.003,0},
  {60.927,95.059,0.003,0},
  {61.306,92.237,0.003,0},
  {61.686,89.415,0.003,0},
  {62.065,86.594,0.003,0},
  {62.445,83.773,0.003,0},
  {62.824,80.954,0.003,0},
  {63.204,78.135,0.003,0},
  {63.583,75.317,0.003,0},
  {63.962,72.499,0.003,0},
  {64.341,69.683,0.003,0},
  {64.721,66.867,0.003,0},
  {65.1,64.052,0.003,0},
  {65.479,61.237,0.003,0},
  {65.858,58.424,0.003,0},
  {66.237,55.611,0.003,0},
  {66.616,52.799,0.003,0},
  {66.994,49.987,0.003,0},
  {67.373,47.177,0.003,0},
  {67.752,44.367,0.003,0},
  {68.131,41.557,0.003,0},
  {68.509,38.749,0.003,0},
  {68.888,35.941,0.003,0},
  {69.266,33.134,0.003,0},
  {69.645,30.328,0.003,0},
  {70.023,27.523,0.003,0},
  {70.402,24.718,0.003,0},
  {70.78,21.914,0.003,0},
  {71.158,19.11,0.003,0},
  {71.537,16.308,0.003,0},
  {71.915,13.506,0.003,0},
  {72.293,10.705,0.003,0},
  {72.671,7.905,0.003,0},
  {73.049,5.105,0.003,0},
  {73.427,2.306,0.003,0},
  {73.739,0,0.003,0},
  {73.740,0,0.003,0},
  {73.750,0,0.003,0},
  {73.760,0,0.003,0},
  {73.770,0,0.003,0},
  {73.780,0,0.003,0},
  {73.790,0,0.003,0},
  {73.800,0,0.003,0},
  {73.810,0,0.003,0},
  {73.820,0,0.003,0},
  {73.830,0,0.003,0},
  {73.840,0,0.003,0},
  {73.850,0,0.003,0},
  {73.860,0.003,0},
  {73.870,0,0.003,0},
  };

const int NUM_SAMPLES = sizeof(flightData) / sizeof(flightData[0]);
int sampleIndex = 0;
#endif


const int V_SIZE = 10;

bool batteryAttached = true;

float seaLevel_hPa = 1013.25f;

float max_magnitude = 0.0;

int loopDelay = 100;        // at PAD_PRIMED
unsigned long last_ms = 0;

float maxAlt = 0.0f;


float verticalSpeed_Q[V_SIZE];
int idx_speed = 0;
float prevAlt = 0.0f;
float prevTime = 0.0f;

struct LogRecord {
  uint32_t t_ms;
  float alt;
  float ax, ay, az;
  float v;                // Vertical sliding velocity
  int logState;
};

enum {
  PAD_IDLE, PAD_PRIMED, ASCENT, DESCENT, LANDED
} state;

void logEvent(const char* msg, float value = 0.0f) {
  File f = LittleFS.open("/events.txt", "a");
  if (!f) return;

  f.print(millis());
  f.print(" ms: ");
  
  if (value != 0.0f){
    f.print(msg); f.println(value);
  }
  else {
    f.println(msg);
  }
  f.close();
}

void setup() {
  state = PAD_PRIMED;

  Serial.begin(115200);

  pinMode(PYRO_PIN, OUTPUT);
  digitalWrite(PYRO_PIN, LOW);
  pinMode(BUZZER_PIN, OUTPUT);


  if (!bmp.begin(0x76)) {
    Serial.println("Could not find BMP280 sensor at 0x76");
    while (1) {}
  }
  if (!mpu.begin(MPU_ADDR)) {
    Serial.println("MPU6050 not found at selected address.");
    while (1) {}
  }

  if (!LittleFS.begin()) {
  Serial.println("LittleFS mount failed");
  while (1);
  }

  dumpLog();
  // remove logs
  if (REMOVE){
  LittleFS.remove("/flight.bin");
  LittleFS.remove("/events.txt");
  }

  float voltagePin = analogRead(BATTERY_VOLTAGE_PIN);
  // melkei toimii
  float voltage = (voltagePin / 1023.0f * 3.3f - 0.14f ) * 5.35f; //5.35f
  Serial.print(voltage); Serial.println("V");
  if (voltage < 1){
    batteryAttached = false;
  }

  tone(BUZZER_PIN, 3000, 100);
  delay(200);
  tone(BUZZER_PIN, 3000, 100);

  mpu.setAccelerometerRange(MPU6050_RANGE_16_G);
  // Zero points for sensors
  zeroAlt();

  //tone(16, 2700, 200);
}

void zeroAlt(){
  seaLevel_hPa = bmp.readPressure() / 100.0f;
}

void detectLaunch(float a_magnitude_2) {
  if (a_magnitude_2 > 100*100) {
    state = ASCENT;
    logEvent("LIFTOFF!!");
    loopDelay = 20;
  }
}

void detectApogee(float altM, float a_magnitude_2){
  // Update maximum altitude
  if (altM > maxAlt){
    maxAlt = altM;
  }
  if (altM < maxAlt - 1.0 && a_magnitude_2 < 30*30){
    state = DESCENT;
 
    logEvent("Apogee reached!! At: ", maxAlt);
  }   
  if (altM < maxAlt - 10.0){
    state = DESCENT;
    logEvent("Apogee detection error, descent timeout. At: ", maxAlt);
  }
}

void detectLanding(float v_avg, float a_magnitude_2){
  if (v_avg < 0.2f ){ //&& a_magnitude_2 < 120 && a_magnitude_2 > 100
    state = LANDED;
    logEvent("Touchdown");
    loopDelay = 3000;
    }
}

void logSample(uint32_t t_ms, float altM, float ax, float ay, float az, float v, int logState) {
  File f = LittleFS.open("/flight.bin", "a");
  if (!f) return;
  LogRecord r { t_ms, altM, ax, ay, az, v, logState };
  f.write((uint8_t*)&r, sizeof(r));
  f.close();
}

void dumpLog() {
  File fileLogs = LittleFS.open("/flight.bin", "r");
  if (!fileLogs) {
    Serial.println("No log file");
    return;
  }

  Serial.println("t_ms,alt,ax,ay,az");
  LogRecord r;
  while (fileLogs.read((uint8_t*)&r, sizeof(r)) == sizeof(r)) {
    Serial.print(r.t_ms); Serial.print(",");
    Serial.print(r.alt);  Serial.print(",");
    Serial.print(r.ax);   Serial.print(",");
    Serial.print(r.ay);   Serial.print(",");
    Serial.print(r.az);   Serial.print(",");
    Serial.println(r.logState);
  }

  Serial.println();
  fileLogs.close();
  File fileEvents = LittleFS.open("/events.txt", "r");
  if (!fileEvents) {
    Serial.println("No Events");
    return;
  }

  Serial.println("Event Log:");
  while (fileEvents.available()) {
    String line = fileEvents.readStringUntil('\n');
    Serial.println(line);
  }

  fileEvents.close();
  Serial.println();
}

void addVerticalSpeed(float v) {
  verticalSpeed_Q[idx_speed] = v;
  idx_speed = (idx_speed + 1) %  V_SIZE;
}

float calculateAverage(){
  float sum = 0;
  for (int i = 0; i < V_SIZE; i++){
      sum += verticalSpeed_Q[i];
    }
    return sum / V_SIZE;
}

void loop(){
  // --- MPU6050 reads ---
  sensors_event_t a, w, temp;
  mpu.getEvent(&a, &w, &temp);

  #if SENSOR_READ
    // --- BMP280 reads ---

    float altM = bmp.readAltitude(seaLevel_hPa);
    float dt = (millis() - prevTime) / 1000.0f;
    prevTime = millis();
    
    

    float a_magnitude_2 = a.acceleration.x * a.acceleration.x + a.acceleration.y * a.acceleration.y + a.acceleration.z * a.acceleration.z; 

  #else   // ------------ CSV SIMULATION MODE (ARRAY) ------------

    static float t = 0, altM = 0, az = 0, ax = 0;

    if (sampleIndex < NUM_SAMPLES) {
      Sample s;
      memcpy_P(&s, &flightData[sampleIndex], sizeof(Sample));
      sampleIndex++;

      t    = s.t;
      altM = s.alt;
      az   = s.az;
      ax   = s.ax;
    } else {
      // End of simulated flight: keep last values & slow down
      loopDelay = 1000;
    }

    // Simulated dt from time column
    float dt = (t * 1000.0f - prevTime) / 1000.0f;
    prevTime = t * 1000.0f;

    // Override accelerometer with simulated data
    a.acceleration.x = ax;
    a.acceleration.y = 0.0f;  // no Y data, set to 0
    a.acceleration.z = az;

    float a_magnitude_2 = ax*ax + az*az;
  #endif
  // Debug
  #if DEBUG
    Serial.println(prevTime);
    Serial.print("altM = "); Serial.print(altM); Serial.print(" prevAlt = "); Serial.print(prevAlt); Serial.print(" dt = "); Serial.println(dt);

    Serial.println(v);
    Serial.println(v_avg);
    Serial.println(a_magnitude_2);

    /*
    Serial.println(state);
    Serial.print("magnitude: "); Serial.println(a_magnitude_2);
    if (a_magnitude_2 > max_magnitude) {
      max_magnitude = a_magnitude_2;
    }
    Serial.print("Max magnitude: "); Serial.println(max_magnitude);
    
    Serial.print(tC, 2); Serial.print(" Â°C  ");
    Serial.print(pPa, 0); Serial.print(" Pa  ");
    
    Serial.print(altM, 2); Serial.println(" m");
    
    Serial.print(a.acceleration.x, 2); Serial.print(", ");
    Serial.print(a.acceleration.y, 2); Serial.print(", ");
    Serial.println(a.acceleration.z, 2);

    Serial.print(w.gyro.x - wx_fix, 3); Serial.print(", ");
    Serial.print(w.gyro.y - wy_fix, 3); Serial.print(", ");
    Serial.println(w.gyro.z - wz_fix, 3);
    */
    Serial.println();
  #endif
  
  float v = (altM - prevAlt) / dt;
  addVerticalSpeed(v);
  float v_avg = calculateAverage();

  logSample(prevTime, altM, a.acceleration.x, a.acceleration.y, a.acceleration.z, v_avg, state);

  switch (state) {
    case PAD_IDLE: {
    //Serial.println("PAD_IDLE");
    } break;

    case PAD_PRIMED: {
    //Serial.println("PAD_PRIMED");
    detectLaunch(a_magnitude_2);
    } break;

    case ASCENT: {
    //Serial.println("ASCENT");
    detectApogee(altM, a_magnitude_2);
    } break;

    case DESCENT: {
    //Serial.println("DESCENT");
    detectLanding(v_avg, a_magnitude_2);
    } break;

    case LANDED: {
    //Serial.println("LANDED");
    tone(BUZZER_PIN, 3000, 100);
    } break;

    default:
      state = PAD_IDLE;
  }  
  
  prevAlt = altM; 
  delay(loopDelay);
}